apiVersion: apps/v1
kind: Deployment
metadata:
  name: locust
  namespace: mlops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: locust
  template:
    metadata:
      labels:
        app: locust
    spec:
      containers:
        - name: locust
          image: locustio/locust
          args:
            - "-f"
            - "/mnt/locust/locustfile.py"
          volumeMounts:
            - name: locust-scripts
              mountPath: /mnt/locust
          ports:
            - containerPort: 8089
      volumes:
        - name: locust-scripts
          configMap:
            name: locust-script
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: locust-script
  namespace: mlops
data:
  locustfile.py: |
    from locust import HttpUser, task, between
    import json

    class DiabetesUser(HttpUser):
        wait_time = between(1, 3)

        @task
        def predict(self):
            payload = {
                "features": {
                    "encounter_id": 1,
                    "patient_nbr": 100001,
                    "race": "Caucasian",
                    "gender": "Female",
                    "age": "[50-60)",
                    "weight": "?",
                    "admission_type_id": 1,
                    "discharge_disposition_id": 1,
                    "admission_source_id": 7,
                    "payer_code": "?",
                    "medical_specialty": "InternalMedicine",
                    "num_lab_procedures": 45,
                    "num_procedures": 2,
                    "num_medications": 15,
                    "number_outpatient": 0,
                    "number_emergency": 0,
                    "number_inpatient": 1,
                    "diag_1": "250.13",
                    "diag_2": "401.9",
                    "diag_3": "414",
                    "max_glu_serum": "None",
                    "A1Cresult": "None",
                    "metformin": "Yes",
                    "repaglinide": "No",
                    "nateglinide": "No",
                    "chlorpropamide": "No",
                    "glimepiride": "No",
                    "acetohexamide": "No",
                    "glipizide": "No",
                    "glyburide": "No",
                    "tolbutamide": "No",
                    "pioglitazone": "No",
                    "rosiglitazone": "No",
                    "acarbose": "No",
                    "miglitol": "No",
                    "troglitazone": "No",
                    "tolazamide": "No",
                    "examide": "No",
                    "citoglipton": "No",
                    "insulin": "No",
                    "glyburide-metformin": "No",
                    "metformin-rosiglitazone": "No",
                    "metformin-pioglitazone": "No",
                    "glipizide-metformin": "No", 
                    "glimepiride-pioglitazone": "No",                
                    "change": "Ch",
                    "diabetesMed": "Yes",
                    "multi_inpatient": 0,
                    "time_in_hospital": 4,
                    "number_diagnoses": 7,
                    "total_visits": 1
                }
            }
            self.client.post("/predict", json=payload)
---
apiVersion: v1
kind: Service
metadata:
  name: locust-service
  namespace: mlops
spec:
  type: NodePort
  ports:
    - port: 8089
      nodePort: 30889
  selector:
    app: locust
